{% extends 'layout.html' %}

{% block title %}Voice Transcription - Intelligent FIR System{% endblock %}

{% block styles %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- Voice Recorder CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/voice-recorder.css') }}">
<style>
    /* Main container styles */
    .container {
        background-color: #72301C;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px #d89d34ad;
        color: #2c3e50;
    }

    /* Page title */
    h1 {
        color: #ffffff;
        font-weight: 700;
        border-bottom: 3px solid #4aa3df;
        padding: 15px;
        background-color: #2c3e50;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(74, 163, 223, 0.3);
        font-size: 28px;
        letter-spacing: 0.5px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Section backgrounds */
    .recording-container,
    .mb-3,
    .recording-controls,
    .status-container,
    .transcription-container,
    .card-body {
        background-color: #ffffff;
        color: #2c3e50;
    }

    .form-label {
        color: #3498db;
    }

    .form-select,
    .transcription-field {
        background-color: #ecf0f1;
        color: #2c3e50;
        border-color: #bdc3c7;
    }

    .record-button {
        background-color: #e74c3c;
        box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    .record-button:hover {
        background-color: #c0392b;
    }

    .stop-button {
        background-color: #95a5a6;
        color: white;
    }

    .stop-button:hover {
        background-color: #7f8c8d;
        color: white;
    }

    .status-recording {
        background-color: #fff8e1;
        border-left-color: #f39c12;
    }

    .status-recording .status-icon,
    .status-recording #recordingStatus,
    .status-recording .status-percentage {
        color: #f39c12;
    }

    .progress-container {
        background-color: #ecf0f1;
        border: 1px solid #bdc3c7;
    }

    .progress-bar {
        background-color: #f39c12;
    }

    .btn-primary {
        background-color: #2980b9;
        border-color: #2980b9;
        color: #ffffff;
    }

    .btn-primary:hover {
        background-color: #2471a3;
        border-color: #1f618d;
        color: white;
    }

    .instructions {
        background-color: #e8f6ff;
        border-left: 6px solid #3498db;
        color: #2c3e50;
    }

    .instructions h4,
    .instructions li,
    .card-header,
    .card-body p,
    .list-unstyled li {
        color: #2c3e50;
    }

    .card-header {
        background-color: #d6eaf8;
        border-bottom: 3px solid #3498db;
    }

    .list-unstyled li i {
        background-color: #ecf0f1;
        border-color: #3498db;
        color: #27ae60;
    }

    .list-unstyled li:hover {
        background-color: rgba(39, 174, 96, 0.2);
        border-left-color: #27ae60;
    }

    #languagesList li::before {
        color: #3498db;
    }

    #languagesList li:hover {
        background-color: rgba(52, 152, 219, 0.2);
        border-bottom-color: #3498db;
    }

    .tips-container, .languages-container {
        background-color: #f0f3f4;
        border-color: #bdc3c7;
    }

    .list-unstyled li span::after {
        background-color: rgba(39, 174, 96, 0.2);
    }
</style>


{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Voice-to-Text Transcription</h1>

    <div class="instructions">
        <h4>Instructions</h4>
        <ul>
            <li>Click the red record button to start recording your voice</li>
            <li>Speak clearly and at a normal pace</li>
            <li>Click the stop button when you're finished</li>
            <li>Wait for the transcription to complete</li>
            <li>Review and edit the transcription as needed</li>
        </ul>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="recording-container">
                <!-- Language Selection -->
                <div class="mb-3">
                    <label for="languageSelector" class="form-label">Select Language</label>
                    <select id="languageSelector" class="form-select">
                        <option value="" disabled selected>Loading languages...</option>
                    </select>
                    <div class="form-text">Choose the language you'll be speaking in</div>
                </div>

                <div class="recording-controls">
                    <button id="recordButton" class="record-button" title="Start Recording">
                        <i class="fas fa-microphone fa-2x"></i>
                    </button>
                    <button id="stopButton" class="stop-button" title="Stop Recording">
                        <i class="fas fa-stop fa-2x"></i>
                    </button>
                </div>

                <div class="status-container">
                    <div class="status-header">
                        <i class="fas fa-info-circle status-icon"></i>
                        <p id="recordingStatus">Ready to record</p>
                    </div>
                    <div class="progress-container">
                        <div id="transcriptionProgress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="statusPercentage" class="status-percentage">0%</div>
                </div>

                <audio id="audioPlayer" class="audio-player" controls></audio>
            </div>

            <div class="transcription-container">
                <div class="transcription-header">
                    <h4><i class="fas fa-file-alt"></i> Transcription</h4>
                    <div class="transcription-actions">
                        <button id="copyTranscriptionButton" class="btn btn-sm btn-outline-primary" title="Copy to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="transcription-field-container">
                    <textarea id="transcriptionField" class="transcription-field" placeholder="Your transcription will appear here...">{{ transcription_text if transcription_text else '' }}</textarea>
                    <!-- Overlay will be hidden by default if there's text -->
                    <div class="transcription-overlay" id="transcriptionOverlay" style="display: none;">
                        <div class="overlay-content">
                            <i class="fas fa-microphone-alt fa-3x"></i>
                            <p>Record your voice to see the transcription here</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-flex justify-content-between">
                    <button id="useTranscriptionButton" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i> Use This Transcription
                    </button>
                    <button id="clearTranscriptionButton" class="btn btn-outline-secondary">
                        <i class="fas fa-times-circle"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb mr-2"></i> Tips for Better Transcription</h5>
                </div>
                <div class="card-body">
                    <div class="tips-container">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check-circle"></i> <span>Speak clearly and at a moderate pace</span></li>
                            <li><i class="fas fa-volume-down"></i> <span>Minimize background noise for better results</span></li>
                            <li><i class="fas fa-comment-alt"></i> <span>Use proper pronunciation of words</span></li>
                            <li><i class="fas fa-microphone"></i> <span>Keep microphone at a consistent distance</span></li>
                            <li><i class="fas fa-paragraph"></i> <span>Speak in complete sentences</span></li>
                            <li><i class="fas fa-tachometer-alt"></i> <span>Avoid speaking too quickly</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-globe mr-2"></i> Supported Languages</h5>
                </div>
                <div class="card-body">
                    <p><i class="fas fa-info-circle mr-2"></i> The system supports the following languages:</p>
                    <div class="languages-container">
                        <ul id="languagesList">
                            <li>English (US)</li>
                            <li>English (UK)</li>
                            <li>English (India)</li>
                            <li>Hindi</li>
                            <li>Bengali</li>
                            <li>Tamil</li>
                            <li>And more...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/voice-recorder.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if there's already text in the transcription field
        const transcriptionField = document.getElementById('transcriptionField');
        const transcriptionOverlay = document.getElementById('transcriptionOverlay');

        if (transcriptionField && transcriptionField.value.trim() !== '') {
            // If there's text, hide the overlay
            if (transcriptionOverlay) {
                transcriptionOverlay.style.display = 'none';
            }
        } else {
            // If there's no text, show the overlay
            if (transcriptionOverlay) {
                transcriptionOverlay.style.display = 'flex';
            }
        }

        // Initialize voice recorder
        const voiceRecorder = new VoiceRecorder({
            recordButtonId: 'recordButton',
            stopButtonId: 'stopButton',
            audioPlayerId: 'audioPlayer',
            transcriptionFieldId: 'transcriptionField',
            statusElementId: 'recordingStatus',
            progressBarId: 'transcriptionProgress',
            languageSelectorId: 'languageSelector',
            uploadEndpoint: '{{ url_for("speech.upload_audio") }}',
            statusEndpoint: '{{ url_for("speech.get_transcription_status", task_id="") }}',
            languagesEndpoint: '{{ url_for("speech.get_supported_languages") }}',
            onTranscriptionComplete: function(text) {
                console.log('Transcription complete:', text);
                // You can add additional actions here
            },
            onError: function(error) {
                console.error('Transcription error:', error);
                // You can add error handling here
            }
        });

        // Clear transcription button
        document.getElementById('clearTranscriptionButton').addEventListener('click', function() {
            document.getElementById('transcriptionField').value = '';
            // Show the overlay when clearing the field
            document.getElementById('transcriptionOverlay').style.display = 'flex';
        });

        // Copy transcription button
        document.getElementById('copyTranscriptionButton').addEventListener('click', function() {
            const transcriptionField = document.getElementById('transcriptionField');
            const text = transcriptionField.value;

            if (text.trim() === '') {
                // Show a tooltip or message that there's nothing to copy
                alert('No text to copy');
                return;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(text).then(function() {
                // Visual feedback for successful copy
                const button = document.getElementById('copyTranscriptionButton');
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-primary');

                // Reset after 2 seconds
                setTimeout(function() {
                    button.innerHTML = originalHTML;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-primary');
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy text to clipboard');
            });
        });

        // Use transcription button
        document.getElementById('useTranscriptionButton').addEventListener('click', function() {
            const transcription = document.getElementById('transcriptionField').value;
            if (transcription.trim() === '') {
                alert('Please record and transcribe your voice first.');
                return;
            }

            // Store in both sessionStorage and localStorage for redundancy
            sessionStorage.setItem('voiceTranscription', transcription);
            localStorage.setItem('voiceTranscription', transcription);

            // Store in server-side session via AJAX with proper error handling
            fetch('{{ url_for("fir.save_transcription") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
                },
                body: JSON.stringify({ transcription: transcription })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to save transcription');
                }
                // Redirect to complaint form only after successful save
                window.location.href = '{{ url_for("fir.new_fir") }}';
            })
            .catch(error => {
                console.error('Error saving transcription:', error);
                alert('There was an error saving the transcription. Please try again.');
            });
        });

        // Hide overlay when text is entered manually
        document.getElementById('transcriptionField').addEventListener('input', function() {
            if (this.value.trim() !== '') {
                document.getElementById('transcriptionOverlay').style.display = 'none';
            } else {
                document.getElementById('transcriptionOverlay').style.display = 'flex';
            }
        });

        // Load supported languages
        fetch('{{ url_for("speech.get_supported_languages") }}')
            .then(response => response.json())
            .then(data => {
                const languagesList = document.getElementById('languagesList');
                languagesList.innerHTML = '';

                // Check if data.languages exists and is an array
                if (data.languages && Array.isArray(data.languages)) {
                    data.languages.forEach(lang => {
                        const li = document.createElement('li');
                        li.textContent = lang.name;
                        languagesList.appendChild(li);
                    });
                } else {
                    // Fallback if languages is not in the expected format
                    languagesList.innerHTML = '<li>English (US)</li><li>English (UK)</li><li>English (India)</li><li>Hindi</li>';
                    console.warn('Languages data not in expected format:', data);
                }
            })
            .catch(error => {
                console.error('Error loading languages:', error);
            });
    });
</script>
{% endblock %}
